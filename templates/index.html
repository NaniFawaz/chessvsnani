<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chess vs Nani</title>
  <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css" />
  <style>
    :root { --gap: 16px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f5f6f8; margin:0; padding:24px; color:#1f2328; }
    h1 { margin:0 0 6px; font-size:28px; }
    .sub{ margin:0 0 18px; color:#6a737d; }
    .wrap{ display:grid; gap:var(--gap); grid-template-columns:1fr minmax(280px,560px); align-items:start; }
    @media (max-width:900px){ .wrap{ grid-template-columns:1fr; } }
    .panel{ background:#fff; border-radius:12px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    .avatar{ width:100%; max-width:360px; border-radius:12px; display:block; margin:0 auto 12px; }
    .modes{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .modes button{ border:1px solid #d0d7de; padding:8px 12px; border-radius:999px; background:#fff; cursor:pointer; }
    .modes button.active{ background:#111827; color:#fff; border-color:#111827; }
    #board{ width:520px; max-width:92vw; margin:8px auto 0; touch-action:none; user-select:none; }
    .bar{ display:flex; justify-content:center; margin-top:10px; }
    .bar button{ border:1px solid #d0d7de; background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .chessboard-1.0 .piece{ transition:none !important; }
  </style>
</head>
<body>
  <h1>Chess vs Nani</h1>
  <p class="sub">Current mode: <strong id="modeLabel">Sleeping Nani</strong></p>

  <div class="wrap">
    <section class="panel">
      <img id="avatar" class="avatar" src="/static/images/sleeping.png" alt="Nani" />
      <div class="modes">
        <button id="btn-sleeping" class="active">ðŸ˜´ Sleeping Nani</button>
        <button id="btn-blindfold">ðŸ«£ Blindfold Nani</button>
        <button id="btn-nani">ðŸ”¥ Nani</button>
      </div>
    </section>

    <section class="panel">
      <div id="board"></div>
      <div class="bar"><button id="btn-restart">â†» Restart</button></div>
    </section>
  </div>

  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <script src="/static/js/chess.min.js"></script>
  <script src="/static/js/chessboard-1.0.0.min.js"></script>
  <script>
    const pieceTheme = (p)=> '/static/pieces/wikipedia/'+p+'.png';
    ['wP','wN','wB','wR','wQ','wK','bP','bN','bB','bR','bQ','bK'].forEach(c=>{ const i=new Image(); i.src=pieceTheme(c); });

    const BoardLib = window.Chessboard || window.ChessBoard;
    const $mode = document.getElementById('modeLabel');
    const $avatar = document.getElementById('avatar');

    let game = new Chess();
    let board = null;
    let initialized = false;

    function setButtons(state){
      document.getElementById('btn-sleeping').classList.toggle('active', state==='sleeping');
      document.getElementById('btn-blindfold').classList.toggle('active', state==='blindfold');
      document.getElementById('btn-nani').classList.toggle('active', state==='nani');
      $mode.textContent = state==='sleeping' ? 'Sleeping Nani' : state==='blindfold' ? 'Blindfold Nani' : 'Nani';
      $avatar.src = state==='sleeping' ? '/static/images/sleeping.png'
                 : state==='blindfold' ? '/static/images/blindfold.png' : '/static/images/nani.png';
    }

    function getJSON(url){ return fetch(url).then(r=>r.json()); }
    function postJSON(url, data){
      return fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data||{})})
        .then(async r => { const t=await r.text(); try{ return JSON.parse(t); }catch{ return {error:'bad json', raw:t}; }});
    }

    function initBoard(){
      getJSON('/get_fen').then(({fen})=>{
        game = new Chess(fen || undefined);
        board = BoardLib('board', { position: game.fen(), draggable:true, pieceTheme, onDrop });
        window.addEventListener('resize', ()=> board && board.resize());
        initialized = true;
      }).catch(()=>{
        game = new Chess();
        board = BoardLib('board', { position:'start', draggable:true, pieceTheme, onDrop });
        initialized = true;
      });
    }

    function onDrop(source, target){
      if(!initialized) return 'snapback';

      // local legality check first
      const test = new Chess(game.fen());
      const mv = test.move({from: source, to: target, promotion:'q'});
      if(!mv) return 'snapback';

      // apply locally for instant feedback
      game = test;
      board.position(game.fen());

      // send ALL common shapes so backend accepts whatever it expects
      const payload = {
        from: source, to: target,
        source, target,
        uci: source + target,
        promotion: 'q'
      };

      postJSON('/move', payload).then(res=>{
        if(res && res.fen){
          game = new Chess(res.fen); board.position(res.fen());
        }else if(res && res.error){
          alert(res.error);
          // resync with server
          getJSON('/get_fen').then(r=>{ if(r && r.fen){ game = new Chess(r.fen); board.position(r.fen()); }});
        }else{
          // unknown response -> resync
          getJSON('/get_fen').then(r=>{ if(r && r.fen){ game = new Chess(r.fen); board.position(r.fen()); }});
        }
      }).catch(err=>{
        console.error(err);
        getJSON('/get_fen').then(r=>{ if(r && r.fen){ game = new Chess(r.fen); board.position(r.fen()); }});
      });
    }

    function choose(state){
      postJSON('/set_difficulty', {state}).then(res=>{
        if(res && res.fen){ game = new Chess(res.fen); board.position(res.fen()); }
        setButtons(state);
      }).catch(()=> alert('Could not reach the server.'));
    }

    document.getElementById('btn-sleeping').onclick = ()=> choose('sleeping');
    document.getElementById('btn-blindfold').onclick = ()=> choose('blindfold');
    document.getElementById('btn-nani').onclick = ()=> choose('nani');

    document.getElementById('btn-restart').onclick = ()=>{
      postJSON('/restart', {}).then(r=>{
        if(!(r && r.fen)){ return postJSON('/reset', {}); } // fallback if your server uses /reset
        return r;
      }).then(r=>{
        if(r && r.fen){ game = new Chess(r.fen); board.position(r.fen()); }
      });
    };

    window.addEventListener('load', initBoard, {once:true});
  </script>
</body>
</html>
