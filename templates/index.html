<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess vs Nani</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Local CSS/JS we already put in static -->
  <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; }
    h1 { margin: 0 0 16px; }
    #board { width: 420px; max-width: 90vw; }
    .panel { display: flex; gap: 24px; align-items: flex-start; flex-wrap: wrap; }
    /* stop mobile page scroll while dragging */
    #board { touch-action: none; }
    body { overscroll-behavior: contain; }
    /* no animation flicker on piece image swap */
    .chessboard-clearfix img { transition: none !important; animation: none !important; }
    .bar { margin-top: 10px; }
    button { border: 1px solid #ccc; background: #f7f7f7; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
    button:active { transform: translateY(1px); }
    .mode { font-weight: 600; margin: 0 0 8px; }
  </style>
</head>
<body>
  <h1>Chess vs Nani</h1>
  <div class="mode">Current mode: <span id="mode-label">Sleeping Nani</span></div>

  <div class="panel">
    <div>
      <div id="board"></div>
      <div class="bar"><button id="btn-restart">âŸ² Restart</button></div>
      <div class="bar">
        <button id="btn-sleep">ðŸ˜´ Sleeping Nani</button>
        <button id="btn-blind">ðŸ™ˆ Blindfold Nani</button>
        <button id="btn-nani">ðŸ”¥ Nani</button>
      </div>
    </div>
  </div>

  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <script src="/static/js/chess.min.js"></script>
  <script src="/static/js/chessboard-1.0.0.min.js"></script>

  <script>
    // -------- globals ----------
    let game = null;
    let boardUI = null;
    let initialized = false;
    let currentMode = 'sleeping';

    // Use the local piece images in your repo:
    // (Make sure these 12 PNGs exist in static/pieces/wikipedia/)
    const pieceTheme = (piece) => `/static/pieces/wikipedia/${piece}.png`;

    // Preload 12 images to avoid any flicker
    (function preloadPieces(){
      const codes = ['bK','bQ','bR','bB','bN','bP','wK','wQ','wR','wB','wN','wP'];
      codes.forEach(c => { const i = new Image(); i.src = pieceTheme(c); });
    })();

    function setModeLabel() {
      const label = {
        sleeping: 'Sleeping Nani',
        blindfold: 'Blindfold Nani',
        nani: 'Nani'
      }[currentMode] || 'Sleeping Nani';
      document.getElementById('mode-label').textContent = label;
    }

    // --- init ---
    function initBoard(startFen) {
      game = new Chess(startFen || undefined);

      boardUI = Chessboard('board', {
        position: game.fen(),
        draggable: true,
        pieceTheme,
        onDrop
      });

      initialized = true;
      setModeLabel();
    }

    // --- user drops a piece ---
    function onDrop(source, target) {
      if (!initialized || !game) return 'snapback';

      // Try it locally first (so your move appears instantly)
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (!move) return 'snapback';

      // Show your move immediately
      boardUI.position(game.fen(), true);

      // Ask the server to make Nani's reply and return the new FEN
      fetch('/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from: source, to: target })
      })
      .then(r => r.json())
      .then(res => {
        if (res.fen) {
          game.load(res.fen);
          boardUI.position(res.fen, true);
        } else if (res.error) {
          // rollback if server rejected (rare, but safe)
          game.undo();
          boardUI.position(game.fen(), true);
          alert(res.error);
        }
      })
      .catch(() => {
        game.undo();
        boardUI.position(game.fen(), true);
        alert('Network error');
      });

      // important: return nothing so drop is accepted
      return;
    }

    function restart() {
      fetch('/restart', { method: 'POST' })
        .then(r => r.json())
        .then(res => {
          game = new Chess(res.fen);
          boardUI.position(res.fen, true);
        });
    }

    function choose(state) {
      fetch('/set_difficulty', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state })
      })
      .then(r => r.json())
      .then(res => {
        if (res.ok) {
          currentMode = state;
          setModeLabel();
          game = new Chess(res.fen);
          boardUI.position(res.fen, true);
        } else if (res.error) {
          alert(res.error);
        }
      })
      .catch(() => alert('Network error'));
    }

    // Wire buttons
    document.addEventListener('DOMContentLoaded', function(){
      $('#btn-restart').on('click', restart);
      $('#btn-sleep').on('click', () => choose('sleeping'));
      $('#btn-blind').on('click', () => choose('blindfold'));
      $('#btn-nani').on('click', () => choose('nani'));

      // Get the starting FEN from server on load
      fetch('/get_fen')
        .then(r => r.json())
        .then(res => initBoard(res.fen))
        .catch(() => initBoard()); // fallback to the normal start
    });
  </script>
</body>
</html>
