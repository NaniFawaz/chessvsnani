<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Chess vs Nani</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7f8;margin:0;color:#111}
    header{max-width:960px;margin:18px auto 8px;padding:0 16px}
    h1{margin:0 0 6px;font-size:28px}
    #modeLine{background:#eee;border-radius:10px;padding:8px 12px;display:inline-block}
    main{max-width:960px;margin:12px auto 40px;display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:0 16px}
    .panel{background:#fff;border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:14px}
    #naniBox img{width:100%;border-radius:10px;display:block;-webkit-user-drag:none;user-select:none}
    #buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{border:0;border-radius:999px;padding:8px 14px;background:#eee;cursor:pointer}
    button.active{background:#111;color:#fff}
    #board{max-width:520px;width:92vw;margin:12px auto}
    .square-55d63{touch-action:none;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none}
    img{-webkit-user-drag:none}
    .bar{display:flex;justify-content:center;margin-top:10px}
    .bar button{background:#e9e9ea}
    @media (max-width: 900px){ main{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>Chess vs Nani</h1>
    <div id="modeLine">Current mode: <b id="modeName">Sleeping Nani</b></div>
  </header>

  <main>
    <div class="panel" id="naniBox">
      <img id="naniImg" src="/static/images/sleeping.png" alt="Nani" />
      <div id="buttons">
        <button id="btn-sleeping" class="active">üò¥ Sleeping Nani</button>
        <button id="btn-blindfold">üï∂Ô∏è Blindfold Nani</button>
        <button id="btn-nani">üî• Nani</button>
      </div>
    </div>

    <div class="panel">
      <div id="board"></div>
      <div class="bar"><button id="btn-restart">‚Ü∫ Restart</button></div>
    </div>
  </main>

  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <script src="/static/js/chess.min.js"></script>
  <script src="/static/js/chessboard-1.0.0.min.js"></script>
  <script>
    const BoardLib = window.Chessboard || window.ChessBoard;

    // LOCAL images (no CDN) ‚Äî this fixes missing pieces and flicker
    const pieceTheme = (piece) => '/static/img/chesspieces/wikipedia/' + piece + '.png';

    // Preload all 12 pieces to avoid any first-move blink
    const PIECES = ['wP','wN','wB','wR','wQ','wK','bP','bN','bB','bR','bQ','bK'];
    function preloadPieces(done){
      let left = PIECES.length;
      PIECES.forEach(code=>{
        const img = new Image();
        img.onload = img.onerror = () => { if(--left===0 && typeof done==='function') done(); };
        img.src = pieceTheme(code);
      });
    }

    let game=null, boardUI=null, currentMode='sleeping', initialized=false;

    function setNaniImage(){
      const map={ sleeping:'/static/images/sleeping.png',
                  blindfold:'/static/images/blindfold.png',
                  nani:'/static/images/nani.png' };
      document.getElementById('naniImg').src = map[currentMode] || map.sleeping;
      document.getElementById('modeName').textContent =
        currentMode==='sleeping'?'Sleeping Nani':
        currentMode==='blindfold'?'Blindfold Nani':'Nani';
    }
    function updateButtons(){
      ['sleeping','blindfold','nani'].forEach(s=>{
        document.getElementById('btn-'+s).classList.toggle('active', s===currentMode);
      });
    }

    async function choose(state){
      if(!initialized){ alert('Board is loading‚Ä¶'); return; }
      try{
        const r = await fetch('/set_difficulty',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({state})});
        const res = await r.json();
        if(res.ok){
          currentMode = res.state;
          game.load(res.fen);
          boardUI.position(game.fen(), false); // no animation = no flicker
          setNaniImage(); updateButtons();
        } else alert(res.error||'Failed to set difficulty');
      }catch{ alert("Couldn't contact the server."); }
    }

    function onDrop(source,target){
      if(!initialized||!game) return 'snapback';
      const p = game.get(source);
      const promo = (p && ((p.color==='w' && target.endsWith('8')) || (p.color==='b' && target.endsWith('1')))) ? 'q' : '';
      const uci = source+target+promo;

      const test = game.move({from:source,to:target,promotion:promo||'q'});
      if(!test) return 'snapback';

      boardUI.position(game.fen(), false); // instant update

      fetch('/move',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({move:uci})})
        .then(r=>r.json())
        .then(res=>{
          if(res.fen){ game.load(res.fen); boardUI.position(game.fen(), false); }
          else { game.undo(); boardUI.position(game.fen(), false); }
        })
        .catch(()=>{ game.undo(); boardUI.position(game.fen(), false); });

      return 'snapback';
    }

    function initBoard(){
      fetch('/get_fen').then(r=>r.json()).then(data=>{
        game = new Chess(data.fen || undefined);
        boardUI = BoardLib('board', {
          draggable:true,
          position:game.fen(),
          pieceTheme:pieceTheme,
          onDrop:onDrop
        });
        initialized=true;
        setNaniImage(); updateButtons();
      }).catch(()=>alert("Couldn't contact the server."));
    }

    document.getElementById('btn-sleeping').onclick = ()=>choose('sleeping');
    document.getElementById('btn-blindfold').onclick = ()=>choose('blindfold');
    document.getElementById('btn-nani').onclick = ()=>choose('nani');
    document.getElementById('btn-restart').onclick = ()=>choose(currentMode);

    preloadPieces(initBoard);
  </script>
</body>
</html>
