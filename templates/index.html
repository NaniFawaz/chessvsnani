<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chess vs Nani</title>
  <link rel="stylesheet" href="/static/css/chessboard-1.0.0.min.css" />
  <style>
    :root { --gap: 16px; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f5f6f8; margin: 0; padding: 24px;
      color: #1f2328;
    }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .sub { margin: 0 0 18px; color: #6a737d; }
    .wrap {
      display: grid; gap: var(--gap);
      grid-template-columns: 1fr minmax(280px, 560px);
      align-items: start;
    }
    @media (max-width: 900px){
      .wrap { grid-template-columns: 1fr; }
    }
    .panel { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,.06); }
    .avatar { width: 100%; max-width: 360px; border-radius: 12px; display:block; margin: 0 auto 12px; }
    .modes { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .modes button {
      border: 1px solid #d0d7de; padding: 8px 12px; border-radius: 999px; background:#fff; cursor:pointer;
    }
    .modes button.active { background:#111827; color:#fff; border-color:#111827; }
    #board { width: 520px; max-width: 92vw; margin: 8px auto 0; touch-action: none; user-select: none; }
    .bar { display:flex; justify-content:center; margin-top:10px; }
    .bar button { border:1px solid #d0d7de; background:#fff; border-radius:8px; padding:8px 12px; cursor:pointer; }
    /* remove any css animations from pieces to avoid flicker */
    .chessboard-1.0 .piece { transition: none !important; }
  </style>
</head>
<body>
  <h1>Chess vs Nani</h1>
  <p class="sub">Current mode: <strong id="modeLabel">Sleeping Nani</strong></p>

  <div class="wrap">
    <!-- Left: character -->
    <section class="panel">
      <img id="avatar" class="avatar" src="/static/images/sleeping.png" alt="Nani" />
      <div class="modes">
        <button id="btn-sleeping" class="active">ðŸ˜´ Sleeping Nani</button>
        <button id="btn-blindfold">ðŸ«£ Blindfold Nani</button>
        <button id="btn-nani">ðŸ”¥ Nani</button>
      </div>
    </section>

    <!-- Right: board -->
    <section class="panel">
      <div id="board"></div>
      <div class="bar"><button id="btn-restart">â†» Restart</button></div>
    </section>
  </div>

  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <script src="/static/js/chess.min.js"></script>
  <script src="/static/js/chessboard-1.0.0.min.js"></script>
  <script>
    // --- helpers ---
    const $mode = document.getElementById('modeLabel');
    const $avatar = document.getElementById('avatar');

    // Use local piece images
    const pieceTheme = (piece) => '/static/pieces/wikipedia/' + piece + '.png';

    // Preload all 12 piece images (prevents flicker)
    ['wP','wN','wB','wR','wQ','wK','bP','bN','bB','bR','bQ','bK'].forEach(code=>{
      const img = new Image(); img.src = pieceTheme(code);
    });

    // Chessboard lib compatibility (Chessboard or ChessBoard)
    const BoardLib = window.Chessboard || window.ChessBoard;

    let game = new Chess();
    let board = null;
    let initialized = false;

    function setButtons(active){
      document.getElementById('btn-sleeping').classList.toggle('active', active==='sleeping');
      document.getElementById('btn-blindfold').classList.toggle('active', active==='blindfold');
      document.getElementById('btn-nani').classList.toggle('active', active==='nani');
      $mode.textContent =
        active==='sleeping' ? 'Sleeping Nani' :
        active==='blindfold' ? 'Blindfold Nani' : 'Nani';
      $avatar.src =
        active==='sleeping' ? '/static/images/sleeping.png' :
        active==='blindfold' ? '/static/images/blindfold.png' : '/static/images/nani.png';
    }

    function initBoard(){
      // get starting FEN from server (keeps server and client in sync)
      fetch('/get_fen').then(r=>r.json()).then(({fen})=>{
        game = new Chess(fen || undefined);
        board = BoardLib('board', {
          position: game.fen(),
          draggable: true,
          pieceTheme: pieceTheme,
          onDrop: onDrop
        });
        window.addEventListener('resize', ()=> board && board.resize());
        initialized = true;
      }).catch(()=>{
        // fallback: start position client only
        game = new Chess();
        board = BoardLib('board', {
          position: 'start',
          draggable: true,
          pieceTheme: pieceTheme,
          onDrop: onDrop
        });
        initialized = true;
      });
    }

    // Try the move locally first (avoids extra roundtrips on illegal moves)
    function onDrop(source, target){
      if(!initialized) return 'snapback';
      const test = new Chess(game.fen());
      const mv = test.move({from: source, to: target, promotion: 'q'});
      if(!mv){ return 'snapback'; }
      // apply locally for instant feedback
      game.move(mv);
      board.position(game.fen());

      // ask server + engine for reply
      fetch('/move', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ from: source, to: target, promotion: 'q' })
      }).then(r=>r.json()).then(res=>{
        if(res.error){ alert(res.error); return; }
        if(res.fen){ game = new Chess(res.fen); board.position(res.fen); }
      }).catch(()=>{ /* ignore network hiccups */ });
    }

    function choose(state){
      fetch('/set_difficulty', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({state})
      }).then(r=>r.json()).then(res=>{
        if(res.fen){ game = new Chess(res.fen); board.position(res.fen); }
        setButtons(state);
      }).catch(()=> alert('Could not reach the server.'));
    }

    // UI actions
    document.getElementById('btn-sleeping').onclick = ()=> choose('sleeping');
    document.getElementById('btn-blindfold').onclick = ()=> choose('blindfold');
    document.getElementById('btn-nani').onclick = ()=> choose('nani');
    document.getElementById('btn-restart').onclick = ()=>{
      fetch('/restart', {method:'POST'}).then(r=>r.json()).then(res=>{
        if(res.fen){ game = new Chess(res.fen); board.position(res.fen); }
      });
    };

    // Start
    window.addEventListener('load', initBoard, {once:true});
  </script>
</body>
</html>
